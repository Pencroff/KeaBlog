var wysibb=wysibb||{};
wysibb.render=function(b){b=b.replace(/</g,"&lt;");$.each(wysibb.options.smileList,function(a,c){b=b.replace(RegExp(wysibb.helpers.prepareRGX(c.bbcode),"g"),wysibb.helpers.strf(c.img,wysibb.options))});$.each(wysibb.options.allButtons,function(a,c){c.transform&&$.each(c.transform,function(a,c){for(var d,e,f=[],g={},n=function(a,b){g[b]=d[a+1]},a=a.replace(/\n/g,""),c=c.replace(/(\(|\)|\[|\]|\.|\*|\?|\:|\\|\\)/g,"\\$1").replace(" ","\\s+"),c=c.replace(/\{\S+?\}/gi,function(a){a=a.substr(1,a.length-
2);f.push(a);return"([\\s\\S]*?)"});null!==(d=RegExp(c,"mgi").exec(b));)d&&($.each(f,n),e=a,e=wysibb.helpers.strf(e,g),b=b.replace(d[0],e))})});$.each(wysibb.options.systr,function(a,c){c=c.replace(/(\(|\)|\[|\]|\.|\*|\?|\:|\\|\\)/g,"\\$1").replace(" ","\\s+");b=b.replace(RegExp(c,"g"),a)});if(hljs)for(var a,c,d,e=0;;){e=b.indexOf("<pre",e);if(-1===e)break;c=b.indexOf("/pre>",e);if(-1===c)break;else c+=5;a=b.substring(e,c);a=$(a)[0];a.parentNode.className||(a.parentNode.className="");hljs.highlightBlock(a,
null,!0);a=a.outerHTML;d=b.substring(0,e);c=b.substring(c);b=d+a+c;e+=a.length}return b};
wysibb.helpers={prepareRGX:function(b){return b.replace(/(\[|\]|\)|\(|\.|\*|\?|\:|\||\\)/g,"\\$1").replace(/\{.*?\}/g,"([\\s\\S]*?)")},strf:function(b,a){a=this.keysToLower($.extend({},a));return b.replace(/\{([\w\.]*)\}/g,function(b,d){var d=d.toLowerCase(),e=d.split("."),f=a[e.shift().toLowerCase()];$.each(e,function(){f=f[this]});return null===f||void 0===f?"":f})},keysToLower:function(b){$.each(b,function(a,c){a!==a.toLowerCase()&&(delete b[a],b[a.toLowerCase()]=c)});return b}};wysibb=wysibb||{};
(function(b){b.wysibb=function(a,c){b(a).data("wbb",this);this.txtArea=a;this.$txtArea=b(a);this.$txtArea.attr("id")||this.setUID(this.txtArea);this.options=wysibb.options;this.options.themePrefix||b("link").each(b.proxy(function(a,c){var f=b(c).get(0).href.match(/(.*\/)(.*)\/wbbtheme\.css.*$/);null!==f&&(this.options.themeName=f[2],this.options.themePrefix=f[1])},this));c&&c.allButtons&&b.each(c.allButtons,b.proxy(function(a,b){b.transform&&this.options.allButtons[a]&&delete this.options.allButtons[a].transform},this));
b.extend(!0,this.options,c);"undefined"!==typeof wysibb.WBBPRESET&&(wysibb.WBBPRESET.allButtons&&b.each(wysibb.WBBPRESET.allButtons,b.proxy(function(a,b){b.transform&&this.options.allButtons[a]&&delete this.options.allButtons[a].transform},this)),b.extend(!0,this.options,wysibb.WBBPRESET));this.init()};b.wysibb.prototype={lastid:1,init:function(){/android.+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|meego.+mobile|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent||
navigator.vendor||window.opera);this.isMobile=void 0;this.controllers=[];this.options.buttons=this.options.buttons.toLowerCase();this.options.buttons=this.options.buttons.split(",");this.options.allButtons._systr={};this.options.allButtons._systr.transform=this.options.systr;this.smileFind();this.initTransforms();this.build();this.initModal();!0===this.options.hotkeys&&!this.isMobile&&this.initHotkeys();this.options.smileList.sort(function(a,b){return b.bbcode.length-a.bbcode.length});this.$txtArea.parents("form").bind("submit",
b.proxy(function(){this.sync();return true},this));b.log(this)},initTransforms:function(){var a,c,d,e=this.options,f=e.buttons.slice();b.log("Create rules for transform HTML=>BB");e.rules||(e.rules={});for(a=0;a<f.length;a+=1)if(c=e.allButtons[f[a]])if("select"===c.type&&"string"===typeof c.options&&(d=c.options.split(","),b.each(d,function(a,c){b.inArray(c,f)===-1&&f.push(c)})),c.transform&&!0!==c.skipRules){for(var g in c.transform){var j=c.transform[g];b.each(e.attrWrap,function(a,b){g=g.replace(b+
'="',"_"+b+'="')});var i=b(document.createElement("DIV")).append(b(this.elFromString(g,document))),h=this.filterByNode(i.children());c.excmd||(c.rootSelector||(c.rootSelector=[]),c.rootSelector.push(h));c.bbSelector||(c.bbSelector=[]);-1==b.inArray(j,c.bbSelector)&&c.bbSelector.push(j);"undefined"==typeof e.rules[h]&&(e.rules[h]=[]);var m={};g.match(/\{\S+?\}/)&&i.find("*").each(b.proxy(function(a,d){var e=this.getAttributeList(d);b.each(e,b.proxy(function(a,c){var e=b(d).attr(c);c.substr(0,1)=="_"&&
(c=c.substr(1));var f=e.match(/\{\S+?\}/g);if(f)for(var g=0;g<f.length;g++){var j=f[g].substr(1,f[g].length-2),i=this.relFilterByNode(d,h),l=e!=f[g]?this.getRegexpReplace(e,f[g]):false;m[j.toLowerCase()]={sel:i?b.trim(i):false,attr:c,rgx:l}}},this));var f=[];b(d).is("iframe")||b(d).contents().filter(function(){return this.nodeType===3}).each(b.proxy(function(a,c){var e=c.textContent||c.data;if(typeof e=="undefined")return true;var g=e.match(/\{\S+?\}/g);if(g)for(var j=0;j<g.length;j++){var i=g[j].substr(1,
g[j].length-2),l=this.relFilterByNode(d,h),k=e!=g[j]?this.getRegexpReplace(e,g[j]):false,l=l?b.trim(l):false;if(b.inArray(l,f)>-1||b(c).parent().contents().size()>1){k=b("<span>").html("{"+i+"}");this.setUID(k,"wbb");var o=e.indexOf(i)+i.length+1,o=e.substr(o,e.length-o);c.data=e.substr(0,e.indexOf(i)-1);b(c).after(this.elFromString(o,document)).after(k);l=(l?l+" ":"")+this.filterByNode(k);k=false}m[i.toLowerCase()]={sel:l,attr:false,rgx:k};f[f.length]=l}},this));f=null;e=i.html();if(g!=e){delete c.transform[g];
c.transform[e]=j;g=e}},this));e.rules[h].push([j,m])}d=b.map(c.transform,function(a,b){return b}).sort(function(a,b){return(b[0]||"").length-(a[0]||"").length});c.bbcode=c.transform[d[0]];c.html=d[0]}this.options.btnlist=f;b.extend(e.rules,this.options.customRules);b.each(e.systr,b.proxy(function(a,b){if(!a.match(/\{\S+?\}/)){var c=this.elFromString(a,document).tagName.toLowerCase();e.rules[c]=[];e.rules[c].push([b,{}])}},this));e.srules={};b.each(e.smileList,b.proxy(function(a,c){var d=this.filterByNode(b(this.strf(c.img,
e)));e.srules[d]=[c.bbcode,c.img]},this));for(var k in e.rules)this.options.rules[k].sort(function(a,b){return b[0].length-a[0].length})},build:function(){b.log("Build editor");this.$editor=b("<div>").addClass("wysibb");this.$editor.insertAfter(this.txtArea).append(this.txtArea);this.$txtArea.css("border","0").css("outline","none").css("padding","0").css("margin","0");this.buildToolbar();this.$txtArea.wrap('<div class="wysibb-text">');if(!1===this.options.onlyBBmode){var a=this.$txtArea.outerHeight();
this.$iFrame=b(this.strf('<iframe src="about:blank" class="wysibb-text-iframe" frameborder="0" style="height:{height}px;"></iframe>',{height:a}));this.$txtArea.css("width","100%").hide();this.$iFrame.bind("load",b.proxy(function(){b.log("Frame loaded");this.framewindow=this.$iFrame.get(0).contentWindow;this.doc=this.framewindow.document;this.body=this.doc.body;this.$body=b(this.doc.body);var a=this.doc.getElementsByTagName("head")[0];this.$body.addClass("wysibb-body").addClass(this.options.bodyClass);
b("link[rel='stylesheet']").each(function(d,f){b(a).append(b(f).clone()[0].outerHTML)});b("style").each(function(d,f){b(a).append(b(f).clone()[0].outerHTML)});if("contentEditable"in this.body){this.body.contentEditable=!0;try{this.doc.execCommand("StyleWithCSS",!1,!1)}catch(d){}}else this.options.onlyBBmode=this.options.bbmode=!0;0<this.txtArea.value.length&&this.$body.html(this.getHTML(this.txtArea.value,!0));b(this.doc).bind("keydown",b.proxy(function(a){if(86==a.which&&(!0==a.ctrlKey||!0==a.metaKey)||
45==a.which&&(!0==a.shiftKey||!0==a.metaKey)){this.getRange();this.$body.removeAttr("contentEditable");var c=b("<div>");this.lastRange=this.getRange();c.attr("contenteditable","true").attr("class","paste").appendTo(this.body).focus();setTimeout(b.proxy(function(){this.clearPaste(a.currentTarget);var b=c.html();c.remove();this.$body.attr("contentEditable","true");this.body.focus();this.insertAtCursor(b,!1);this.lastRange=!1},this),1)}},this));b(this.doc).bind("keydown",b.proxy(function(a){13==a.which&&
!this.isContain(this.getSelectNode(),"li")&&(a.preventDefault&&a.preventDefault(),this.checkForLastBR(this.getSelectNode()),this.insertAtCursor("<br/>",!1))},this));b(this.doc).bind("mouseup keyup",b.proxy(this.updateUI,this));b(this.doc).bind("mousedown",b.proxy(function(a){this.checkForLastBR(a.target)},this));!0===this.options.hotkeys&&b(this.doc).bind("keydown",b.proxy(this.presskey,this))},this)).insertAfter(this.$txtArea)}this.$editor.append('<span class="powered">Powered by <a href="http://www.wysibb.com" target="_blank">WysiBB<a/> and updated by <a href="https://plus.google.com/u/0/103666120703025342706/about" target="_blank">Pencroff<a/></span>');
this.$txtArea.bind("mouseup keyup",b.proxy(this.updateUI,this));!0===this.options.hotkeys&&b(document).bind("keydown",b.proxy(this.presskey,this))},buildToolbar:function(){if(!1===this.options.toolbar)return!1;this.$toolbar=b("<div>").addClass("wysibb-toolbar").prependTo(this.$editor);var a;b.each(this.options.buttons,b.proxy(function(c,d){var e=this.options.allButtons[d];if(0==c||"|"==d)a=b('<div class="wysibb-toolbar-container">').appendTo(this.$toolbar);e&&("colorpicker"==e.type?this.buildColorpicker(a,
d,e):"table"==e.type?this.buildTablepicker(a,d,e):"select"==e.type?this.buildSelect(a,d,e):"smilebox"==e.type?this.buildSmilebox(a,d,e):this.buildButton(a,d,e))},this));this.$toolbar.find(".btn-tooltip").hover(function(){b(this).parent().css("overflow","hidden")},function(){b(this).parent().css("overflow","visible")});b(document.createElement("div")).addClass("wysibb-toolbar-container modeSwitch").html('<div class="wysibb-toolbar-btn" unselectable="on"><span class="btn-inner ve-tlb-bbcode" unselectable="on"></span></div>').appendTo(this.$toolbar).children(".wysibb-toolbar-btn").click(b.proxy(function(a){b(a.currentTarget).toggleClass("on");
this.modeSwitch()},this));b.browser.msie&&this.$toolbar.find("*").attr("unselectable","on")},buildButton:function(a,c,d){"object"!=typeof a&&(a=this.$toolbar);var e=d.buttonHTML?b(this.strf(d.buttonHTML,this.options)).addClass("btn-inner"):this.strf('<span class="btn-inner btn-text">{text}</span>',{text:d.buttonText.replace(/</g,"&lt;")}),f=!0===this.options.hotkeys&&!0===this.options.showHotkeys&&d.hotkey?' <span class="tthotkey">['+d.hotkey+"]</span>":"",a=b('<div class="wysibb-toolbar-btn wbb-'+
c+'">').appendTo(a).append(e).append(this.strf('<span class="btn-tooltip">{title}<ins/>{hotkey}</span>',{title:d.title,hotkey:f}));this.controllers.push(a);a.bind("queryState",b.proxy(function(a){this.queryState(c)?b(a.currentTarget).addClass("on"):b(a.currentTarget).removeClass("on")},this));a.click(b.proxy(function(a){this.execCommand(c,d.exvalue||false);b(a.currentTarget).trigger("queryState")},this));a.mousedown(function(a){a.preventDefault&&a.preventDefault()})},buildColorpicker:function(a,c,
d){var c=d.buttonHTML?b(this.strf(d.buttonHTML,this.options)).addClass("btn-inner"):this.strf('<span class="btn-inner btn-text">{text}</span>',{text:d.buttonText?d.buttonText.replace(/</g,"&lt;"):"Btn"}),e=b('<div class="wysibb-toolbar-btn wbb-dropdown wbb-cp">').appendTo(a).append(c.append('<ins class="ar"/>')).append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:d.title})),f=e.find(".cp-line"),a=b('<div class="wbb-list">').appendTo(e);a.append('<div class="nc">'+this.options.currentLang.auto+
"</div>");d=d.colors?d.colors.split(","):[];for(c=0;c<d.length;c++)d[c]=b.trim(d[c]),"-"==d[c]?a.append('<span class="pl"></span>'):a.append(this.strf('<div class="sc" style="background:{color}" title="{color}"></div>',{color:d[c]}));var g=b(document.body).css("color");this.controllers.push(e);e.bind("queryState",b.proxy(function(){f.css("background-color",g);var a=this.queryState("fontcolor",!0);a&&f.css("background-color",this.options.bbmode?a.color:a)},this));e.click(b.proxy(function(a){this.dropdownclick(".wbb-cp",
".wbb-list",a)},this));e.find(".sc").click(b.proxy(function(a){this.execCommand("fontcolor",b(a.currentTarget).attr("title"));e.trigger("queryState");b.browser.msie&&(this.lastRange=!1)},this));e.find(".nc").click(b.proxy(function(){this.execCommand("fontcolor",g);e.trigger("queryState")},this));e.mousedown(function(a){a.preventDefault&&a.preventDefault()})},buildTablepicker:function(a,c,d){var c=d.buttonHTML?b(this.strf(d.buttonHTML,this.options)).addClass("btn-inner"):this.strf('<span class="btn-inner btn-text">{text}</span>',
{text:d.buttonText?d.buttonText.replace(/</g,"&lt;"):"Btn"}),a=b('<div class="wysibb-toolbar-btn wbb-dropdown wbb-tbl">').appendTo(a).append(c.append('<ins class="ar"/>')).append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:d.title})),c=b('<div class="wbb-list">').appendTo(a),e=d.rows||10,f=d.cols||10,g=e*f;c.css("width",f*d.cellwidth+2+"px").css("height",e*d.cellwidth+2+"px");for(var j=1;j<=f;j++)for(var i=1;i<=e;i++){var h='<div class="tbl-sel" style="width:'+j*d.cellwidth+
"px;height:"+i*d.cellwidth+"px;z-index:"+--g+'" title="'+i+","+j+'"></div>';c.append(h)}a.find(".tbl-sel").click(b.proxy(function(a){for(var a=b(a.currentTarget).attr("title").split(","),c=this.options.bbmode?"[table]":'<table class="wbb-table" cellspacing="5" cellpadding="0">',d=1;d<=a[0];d++){for(var c=c+(this.options.bbmode?" [tr]\n":"<tr>"),e=1;e<=a[1];e++)c+=this.options.bbmode?"  [td][/td]\n":"<td>\ufeff</td>";c+=this.options.bbmode?"[/tr]\n":"</tr>"}c+=this.options.bbmode?"[/table]":"</table>";
this.insertAtCursor(c)},this));a.click(b.proxy(function(a){this.dropdownclick(".wbb-tbl",".wbb-list",a)},this))},buildSelect:function(a,c,d){for(var e=b('<div class="wysibb-toolbar-btn wbb-select wbb-'+c+'">').appendTo(a).append(this.strf('<span class="val">{title}</span><ins class="sar"/>',d)).append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:d.title})),a=b('<div class="wbb-list">').appendTo(e),f=e.find("span.val"),g=b.isArray(d.options)?d.options:d.options.split(","),j=0;j<
g.length;j++){var i=g[j];if("string"==typeof i){var h=this.options.allButtons[i];h&&(b.log("create: "+i),h.html?b("<span>").addClass("option").attr("oid",i).attr("cmdvalue",h.exvalue).appendTo(a).append(this.strf(h.html,{seltext:h.title})):a.append(this.strf('<span class="option" oid="'+i+'" cmdvalue="'+h.exvalue+'">{title}</span>',h)))}else h={seltext:i.title},h[d.valueBBname]=i.exvalue,b("<span>").addClass("option").attr("oid",c).attr("cmdvalue",i.exvalue).appendTo(a).append(this.strf(d.html,h))}this.controllers.push(e);
e.bind("queryState",b.proxy(function(){f.text(d.title);e.find(".option.selected").removeClass("selected");e.find(".option").each(b.proxy(function(a,c){var d=b(c);if(this.queryState(d.attr("oid"),!0)==d.attr("cmdvalue"))return f.text(d.text()),d.addClass("selected"),!1},this))},this));e.click(b.proxy(function(a){this.dropdownclick(".wbb-select",".wbb-list",a)},this));e.find(".option").click(b.proxy(function(a){var c=b(a.currentTarget).attr("oid"),d=b(a.currentTarget).attr("cmdvalue");this.execCommand(c,
this.options.allButtons[c].exvalue||d||!1);b(a.currentTarget).trigger("queryState");this.lastRange&&(this.lastRange=!1)},this))},buildSmilebox:function(a,c,d){var e=b(this.strf(d.buttonHTML,d)).addClass("btn-inner");e.append('<ins class="ar"/>');var a=b('<div class="wysibb-toolbar-btn wbb-smilebox wbb-dropdown wbb-'+c+'">').appendTo(a).append(e).append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:d.title})),f=b('<div class="wbb-list">').appendTo(a);b.isArray(this.options.smileList)&&
b.each(this.options.smileList,b.proxy(function(a,c){b("<span>").addClass("smile").appendTo(f).append(b(this.strf(c.img,this.options)).attr("title",c.title))},this));a.click(b.proxy(function(a){this.dropdownclick(".wbb-smilebox",".wbb-list",a)},this));a.find(".smile").click(b.proxy(function(a){this.insertAtCursor(this.options.bbmode?this.toBB(a.currentTarget):b(b(a.currentTarget).html()))},this))},updateUI:function(a){(8<=a.which&&46>=a.which||90<a.which||"mouseup"==a.type)&&b.each(this.controllers,
b.proxy(function(a,b){b.trigger("queryState")},this));!0===this.options.autoresize&&this.autoresize()},initModal:function(){b.log("Init modal");this.$modal=b("<div>").attr("id","wbbmodal").prependTo(document.body).html('<div class="wbbm"><div class="wbbm-title"><span class="wbbm-title-text"></span><span class="wbbclose" title="'+this.options.currentLang.close+'">\u00d7</span></div><div class="wbbm-content"></div><div class="wbbm-bottom"><button id="wbbm-submit" class="wbb-button">'+this.options.currentLang.save+
'</button><button id="wbbm-cancel" class="wbb-cancel-button">'+this.options.currentLang.cancel+'</button><button id="wbbm-remove" class="wbb-remove-button">'+this.options.currentLang.remove+"</button></div></div>").hide();this.$modal.find("#wbbm-cancel,.wbbclose").click(b.proxy(this.closeModal,this));this.$modal.bind("click",b.proxy(function(a){0==b(a.target).parents(".wbbm").size()&&this.closeModal()},this));b(document).bind("keyup",b.proxy(this.escModal,this));!0!==this.options.onlyBBmode&&b(this.doc).bind("keyup",
b.proxy(this.escModal,this))},initHotkeys:function(){b.log("initHotkeys");this.hotkeys=[];b.each(this.options.allButtons,b.proxy(function(a,c){if(c.hotkey){var d=c.hotkey.split("+");if(d&&2<=d.length){var e=0,f=d.pop();b.each(d,function(a,c){switch(b.trim(c.toLowerCase())){case "ctrl":e+=1;break;case "shift":e+=4;break;case "alt":e+=7}});0<e&&(this.hotkeys["m"+e]||(this.hotkeys["m"+e]=[]),this.hotkeys["m"+e]["k"+("0123456789       abcdefghijklmnopqrstuvwxyz".indexOf(f)+48)]=a)}}},this))},presskey:function(a){if(!0==
a.ctrlKey||!0==a.shiftKey||!0==a.altKey){var b=(!0==a.ctrlKey?1:0)+(!0==a.shiftKey?4:0)+(!0==a.altKey?7:0);if(this.hotkeys["m"+b]&&this.hotkeys["m"+b]["k"+a.which])return this.execCommand(this.hotkeys["m"+b]["k"+a.which],!1),a.preventDefault(),!1}},execCommand:function(a,c){var d=this.options.allButtons[a],e=this.queryState(a,c);d.excmd?this.options.bbmode?(b.log("Native command in bbmode: "+a),e&&!0!=d.subInsert?this.wbbRemoveCallback(a,c):(e={},d.valueBBname&&c&&(e[d.valueBBname]=c),this.insertAtCursor(this.getBBCodeByCommand(a,
e)))):this.execNativeCommand(d.excmd,c||!1):d.cmd?d.cmd.call(this,a,c,e):this.wbbExecCommand.call(this,a,c,e)},queryState:function(a,b){var d=this.options.allButtons[a];if(this.options.bbmode){for(var e=0;e<d.bbSelector.length;e++){var f=this.isBBContain(d.bbSelector[e]);if(f)return this.getParams(f,d.bbSelector[e],f[1])}return!1}if(d.excmd)return b?(e=(this.doc.queryCommandValue(d.excmd)+"").replace(/\'/g,""),"foreColor"==d.excmd&&(e=this.rgbToHex(e)),e):this.doc.queryCommandState(d.excmd);for(e=
0;e<d.rootSelector.length;e++)if(f=this.isContain(this.getSelectNode(),d.rootSelector[e]))return this.getParams(f,d.rootSelector[e]);return!1},wbbExecCommand:function(a,c,d){b.log("wbbExecCommand");var e=this.options.allButtons[a];e.modal?b.isFunction(e.modal)?e.modal.call(this,a,e.modal,d):this.showModal.call(this,a,e.modal,d):d&&!0!=e.subInsert?this.wbbRemoveCallback(a):this.wbbInsertCallback(a,c)},wbbInsertCallback:function(a,c){"object"!=typeof c&&(c={});b.log("wbbInsertCallback: "+a);this.insertAtCursor(this.getCodeByCommand(a,
c));var d=this.getSelectNode();3==d.nodeType&&(d=d.parentNode);b(d).is("span,font")&&this.selectNode(d)},wbbRemoveCallback:function(a,c){b.log("wbbRemoveCallback: "+a);var d=this.options.allButtons[a];if(this.options.bbmode){this.getCursorPosBB();var e=0;b.each(d.bbSelector,b.proxy(function(a,d){var f=d.match(/\{[\s\S]+?\}/g);b.each(f,function(a,b){if("{seltext}"==b.toLowerCase())return e=a,!1});if(f=this.isBBContain(d))return this.txtArea.value=this.txtArea.value.substr(0,f[1])+this.txtArea.value.substr(f[1],
this.txtArea.value.length-f[1]).replace(f[0][0],!0===c?"":f[0][e+1]),this.setCursorPosBB(f[1]),!1},this))}else{var f=this.getSelectNode();b.each(d.rootSelector,b.proxy(function(d,e){var i=this.isContain(f,e),h=b(i),m=this.options.rules[e][0][1];if(h.is("span[wbb]")||!h.is("span,font"))!0===c?h.remove():m&&m.seltext&&m.seltext.sel?h.replaceWith(h.find(m.seltext.sel).html()):h.replaceWith(h.html());else{var k=this.getRange(),m=this.getSelectText();this.getSelectNode();b.log("selHTML: "+m);var m=""==
m?"\ufeff":this.clearFromSubInsert(m,a),m=this.elFromString(m),l=window.getSelection?k.cloneRange():this.body.createTextRange(),n=window.getSelection?k.cloneRange():this.body.createTextRange();window.getSelection?(this.insertAtCursor('<span id="wbbdivide"></span>'),k=h.find("span#wbbdivide").get(0),l.setStart(i.firstChild,0),l.setEndBefore(k),n.setStartAfter(k),n.setEndAfter(i.lastChild)):(l.moveToElementText(i),n.moveToElementText(i),l.setEndPoint("EndToStart",k),n.setEndPoint("StartToEnd",k));i=
this.getSelectText(!1,l);n=this.getSelectText(!1,n);""!=n&&(n=h.clone().html(n),h.after(n));!0!==c&&h.after(m);window.getSelection?(h.html(i),!0!==c&&this.selectNode(m)):h.replaceWith(i)}return!1},this))}},execNativeCommand:function(a,c){b.log("execNativeCommand: '"+a+"' : "+c);this.body.focus();if("insertHTML"==a&&!window.getSelection){var d=this.lastRange?this.lastRange:this.doc.selection.createRange();d.pasteHTML(c);var e=b("<div>").html(c).text(),f=e.indexOf("\ufeff");-1<f&&(d.moveStart("character",
-1*(e.length-f)),d.select());this.lastRange=!1}else"insertHTML"==a?(b.log("Chrome"),d=this.getSelection(),e=this.elFromString(c),f=this.lastRange?this.lastRange:this.getRange(),f.deleteContents(),f.insertNode(e),f.collapse(!1),d.removeAllRanges(),d.addRange(f)):("undefined"==typeof c&&(c=!1),this.lastRange&&(b.log("Last range select"),this.selectRange(this.lastRange),this.lastRange=!1),this.doc.execCommand(a,!1,c))},getCodeByCommand:function(a,b){return this.options.bbmode?this.getBBCodeByCommand(a,
b):this.getHTMLByCommand(a,b)},getBBCodeByCommand:function(a,c){if(!this.options.allButtons[a])return"";"undefined"==typeof c&&(c={});c=this.keysToLower(c);c.seltext||(c.seltext=this.getSelectText(!0));var d=this.options.allButtons[a].bbcode,d=this.strf(d,c),e=null,f=[];b.each(this.options.allButtons[a].transform,function(a,b){f.push(b)});f=this.sortArray(f,-1);b.each(f,function(a,b){var d=!0,b=b.replace(/\{\S+?\}/g,function(a){a=a.substr(1,a.length-2);(a=c[a.toLowerCase()])||(d=!1);return a});if(d)return e=
b,!1});return e||d},getHTMLByCommand:function(a,c){if(!this.options.allButtons[a])return"";c=this.keysToLower(c);"undefined"==typeof c&&(c={});c.seltext||(c.seltext=this.getSelectText(!1),b.log("seltext: '"+c.seltext+"'"),c.seltext=""==c.seltext?"\ufeff":this.clearFromSubInsert(c.seltext,a));var d=this.options.allButtons[a].html,d=this.strf(d,c),e=null,f=[];b.each(this.options.allButtons[a].transform,function(a){f.push(a)});f=this.sortArray(f,-1);b.each(f,function(a,b){var d=true,b=b.replace(/\{\S+\}/g,
function(a){a=a.substr(1,a.length-2);(a=c[a.toLowerCase()])||(d=false);return a});if(d){e=b;return false}});return e||d},getSelection:function(){if(window.getSelection)return this.options.bbmode?window.getSelection():this.framewindow.getSelection();if(document.selection)return this.options.bbmode?document.selection.createRange():this.doc.selection.createRange()},getSelectText:function(a,c){if(a)return this.txtArea.focus(),"selectionStart"in this.txtArea?this.txtArea.value.substr(this.txtArea.selectionStart,
this.txtArea.selectionEnd-this.txtArea.selectionStart):document.selection.createRange().text;this.body.focus();c||(c=this.getRange());if(this.framewindow.getSelection){if(c)return b("<div>").append(c.cloneContents()).html()}else return c.htmlText;return""},getRange:function(){if(window.getSelection){var a=this.getSelection();if(a.getRangeAt&&0<a.rangeCount)return a.getRangeAt(0);if(a.anchorNode){var b=this.options.bbmode?document.createRange():this.doc.createRange();b.setStart(a.anchorNode,a.anchorOffset);
b.setEnd(a.focusNode,a.focusOffset);return b}}else return!0===this.options.bbmode?document.selection.createRange():this.doc.selection.createRange()},insertAtCursor:function(a,c){"string"!=typeof a&&(a=b("<div>").append(a).html());if(this.options.bbmode&&"undefined"==typeof c||!0===c){var d=a.replace(/.*(\[\/\S+?\])$/,"$1"),d=this.getCursorPosBB()+a.indexOf(d);if(document.selection)this.txtArea.focus(),this.getSelection().text=a;else if(this.txtArea.selectionStart||"0"==this.txtArea.selectionStart)this.txtArea.value=
this.txtArea.value.substring(0,this.txtArea.selectionStart)+a+this.txtArea.value.substring(this.txtArea.selectionEnd,this.txtArea.value.length);0>d&&(d=0);this.setCursorPosBB(d)}else this.execNativeCommand("insertHTML",a),d=this.getSelectNode(),b(d).closest("table,tr,td")||this.splitPrevNext(d)},getSelectNode:function(a){this.body.focus();a||(a=this.getRange());return window.getSelection?a.commonAncestorContainer:a.parentElement()},getCursorPosBB:function(){var a=0;if("selectionStart"in this.txtArea)a=
this.txtArea.selectionStart;else{this.txtArea.focus();var a=this.getRange(),b=document.body.createTextRange();b.moveToElementText(this.txtArea);b.setEndPoint("EndToStart",a);a=b.text.length}return a},setCursorPosBB:function(a){if(this.options.bbmode)if(window.getSelection)this.txtArea.selectionStart=a,this.txtArea.selectionEnd=a;else{var b=this.txtArea.createTextRange();b.collapse(!0);b.move("character",a);b.select()}},selectNode:function(a,b){b||(b=this.getRange());if(window.getSelection){var d=
this.getSelection();b.selectNodeContents(a);d.removeAllRanges();d.addRange(b)}else b.moveToElementText(a),b.select()},selectRange:function(){if(window.getSelection){var a=this.getSelection();a.removeAllRanges();a.addRange(this.lastRange)}else this.lastRange.select()},filterByNode:function(a){var c=b(a),d=c.get(0).tagName.toLowerCase(),a=this.getAttributeList(c.get(0));b.each(a,b.proxy(function(a,f){var g=c.attr(f);if(g&&!g.match(/\{.*?\}/))"style"==f?(g=c.attr(f),g=g.split(";"),b.each(g,function(a,
c){c&&0<c.length&&(d+="["+f+'*="'+b.trim(c)+'"]')})):d+="["+f+'="'+g+'"]';else if(g&&"style"==f){var j=g.substr(0,g.indexOf("{"));j&&""!=j&&(g=g.substr(0,g.indexOf("{")),g=g.split(";"),b.each(g,function(a,b){d+="["+f+'*="'+b+'"]'}))}},this));0<c.parent().children(d).index(c)&&(d+=":eq("+c.index()+")");return d},relFilterByNode:function(a,c){for(var d="";a&&"BODY"!=a.tagName&&!b(a).is(c);)d=this.filterByNode(a)+" "+d,a&&(a=a.parentNode);return d},getRegexpReplace:function(a,b){return a=a.replace(/(\(|\)|\[|\]|\.|\*|\?|\:|\\)/g,
"\\$1").replace(/\s+/g,"\\s+").replace(b,"(.+)").replace(/\{\S+\}/g,".*")},getBBCode:function(){if(!this.options.rules||this.options.bbmode)return this.$txtArea.val();this.clearEmpty();return this.toBB(this.$body.html())},toBB:function(a){if(!a)return"";var c="string"==typeof a?b("<span>").html(a):b(a),d="";b.each(this.options.srules,b.proxy(function(a,b){c.find(a).replaceWith(b[0])},this));c.contents().each(b.proxy(function(a,c){var g=b(c);if(3===c.nodeType)d+=c.data.replace(/\n+/,"");else if("BR"==
c.tagName)d+="\n";else{for(var j in this.options.rules)if(g.is(j))for(var i=this.options.rules[j],a=0;a<i.length;a++){var h=i[a][0],m=i[a][1],k=!1,l=!1,h=h.replace(/\{(\S+?)\}/g,function(a){var a=a.substr(1,a.length-2),d=m[a.toLowerCase()];if("undefined"==typeof d)return b.log("Error in configuration of BBCode["+j+"]. Param: {"+a+"} not found in HTML representation."),k=!0,a;var e=d.sel?b(c).find(d.sel):b(c);if(d.attr&&!e.attr(d.attr))return k=!0,a;var h=d.attr?e.attr(d.attr):e.html();if("undefined"==
typeof h)return k=!0,a;(a=d.rgx)&&("style"==d.attr&&";"!=a.substr(a.length-1,1))&&(a+=";");"style"==d.attr&&(h&&";"!=h.substr(h.length-1,1))&&(h+=";");b.log("CONT: "+h);if(a=a?RegExp(a,""):!1)h.match(a)?(a=h.match(a))&&2==a.length&&(h=a[1]):h="";if(d.attr&&!1===k)if("style"==d.attr){l=!0;var i="",p=d.rgx.replace(/^\.\*\?/,"").replace(/\.\*$/,"").replace(/;$/,"");b(e.attr("style").split(";")).each(function(a,b){b&&""!=b&&(b.match(p)||(i+=b+";"))});""==i?e.removeAttr("style"):e.attr("style",i)}else!1===
d.rgx&&(l=!0,e.removeAttr(d.attr));g.is("table,tr,td,font")&&(l=!0);return h||""});if(!k)if(g.is("img,br,hr")){g=b("<span>").html(h);break}else if(l)b.browser.msie?g.empty().append(b("<span>").html(h)):g.empty().html("<span>"+h+"</span>");else{g.is("iframe")?d+=h:g.empty().html(h);break}}if(g.is("iframe"))return!0;d+=this.toBB(g)}},this));return d},getHTML:function(a,b){return!this.options.bbmode&&!b?this.$body.html():wysibb.render(a)},setUID:function(a,c){var d="wbbid_"+ ++this.lastid;b(a).attr(c||
"id",d);return d},keysToLower:function(a){return wysibb.helpers.keysToLower(a)},strf:function(a,b){return wysibb.helpers.strf(a,b)},elFromString:function(a,c){"undefined"==typeof c&&(c=this.doc);if(-1!=a.indexOf("<")&&-1!=a.indexOf(">")){var d=c.createElement("SPAN");b(d).html(a);this.setUID(d,"wbb");return 1<b(d).contents().size()?d:d.firstChild}return c.createTextNode(a)},isContain:function(a,c){for(;a&&"BODY"!=a.tagName;){if(b(a).is(c))return a;if(a)a=a.parentNode;else return null}},isBBContain:function(a){for(var b=
this.getCursorPosBB(),a=this.prepareRGX(a),a=RegExp(a,"g"),d,e=0;null!=(d=a.exec(this.txtArea.value));){e=this.txtArea.value.indexOf(d[0],e);if(b>e&&b<e+d[0].length)return[d,e];e+=1}},prepareRGX:function(a){return wysibb.helpers.prepareRGX(a)},checkForLastBR:function(a){3==a.nodeType&&(a=a.parentNode);a=b(a);if(!1===this.options.bbmode&&a.is("div,blockquote")&&0<a.contents().size()){var c=a[0].lastChild;(!c||c&&"BR"!=c.tagName)&&a.append("<br/>")}0<this.$body.contents().size()&&"BR"!=this.body.lastChild.tagName&&
this.$body.append("<br/>")},getAttributeList:function(a){var c=[];b.each(a.attributes,function(a,b){b.specified&&c.push(b.name)});return c},clearFromSubInsert:function(a,c){var d=b("<div>").html(a);b.each(this.options.allButtons[c].rootSelector,b.proxy(function(a,c){var g=this.options.rules[c][0][1].seltext.sel,j=!0;d.find("*").each(function(){b(this).is(c)&&(g&&g.sel?b(this).replaceWith(b(this).find(g.sel.toLowerCase()).html()):b(this).replaceWith(b(this).html()),j=!1)});return j},this));return d.html()},
splitPrevNext:function(a){3==a.nodeType&&(a=a.parentNode);var c=this.filterByNode(a).replace(/\:eq.*$/g,"");b(a.nextSibling).is(c)&&(b(a).append(b(a.nextSibling).html()),b(a.nextSibling).remove());b(a.previousSibling).is(c)&&(b(a).prepend(b(a.previousSibling).html()),b(a.previousSibling).remove())},modeSwitch:function(){this.options.bbmode?(this.$body.html(this.getHTML(this.$txtArea.val())),this.$txtArea.hide(),this.$iFrame.show()):(this.$txtArea.val(this.getBBCode()),this.$iFrame.hide(),this.$txtArea.show());
this.options.bbmode=!this.options.bbmode},clearEmpty:function(){function a(){if(!b(this).is("span,font,a"))return!1;if(0==b.trim(b(this).html()).length||0<b(this).children().size()&&(b(this).children().filter(a).remove(),0==b(this).html().length&&"BODY"!=this.tagName))return!0}this.$body.children().filter(a).remove()},dropdownclick:function(a,c,d){var e=b(d.currentTarget).closest(a);e.attr("wbbshow")?(e.removeAttr("wbbshow"),b(document).unbind("mousedown",this.dropdownhandler),this.doc&&b(this.doc).unbind("mousedown",
this.dropdownhandler)):(this.$editor.find("*[wbbshow]").each(function(a,c){b(c).removeClass("on").find(b(c).attr("wbbshow")).hide().end().removeAttr("wbbshow")}),e.attr("wbbshow",c),b(document.body).bind("mousedown",b.proxy(function(b){this.dropdownhandler(e,a,c,b)},this)),this.$body&&this.$body.bind("mousedown",b.proxy(function(b){this.dropdownhandler(e,a,c,b)},this)));e.find(c).toggle();e.toggleClass("on")},dropdownhandler:function(a,c,d,e){0==b(e.target).parents(c).size()&&(a.removeClass("on").find(d).hide(),
b(document).unbind("mousedown",this.dropdownhandler),this.$body&&this.$body.unbind("mousedown",this.dropdownhandler))},rgbToHex:function(a){if("#"==a.substr(0,1))return a;if(-1==a.indexOf("rgb"))return a=parseInt(a),"#"+((a&255)<<16|a&65280|(a&16711680)>>>16).toString(16);a=/(.*?)rgb\((\d+),\s*(\d+),\s*(\d+)\)/.exec(a);return"#"+this.dec2hex(parseInt(a[2]))+this.dec2hex(parseInt(a[3]))+this.dec2hex(parseInt(a[4]))},dec2hex:function(a){return 15<a?a.toString(16):"0"+a.toString(16)},sync:function(){this.options.bbmode&&
this.doc?this.$body.html(this.getHTML(this.txtArea.value,!0)):this.$txtArea.val(this.getBBCode())},clearPaste:function(a){b.log("Paste");var c=b(a);b.each(this.options.rules,b.proxy(function(a){c.find(a).attr("wbbkeep",1)},this));c.find("*[wbbkeep!='1']").each(function(){var a=b(this);a.is("div,p")&&(0==a.children()||"BR"!=this.lastChild.tagName)?a.after("<br/>").after(a.contents()).remove():a.after(a.contents()).remove()});c.find("*[wbbkeep='1']").removeAttr("wbbkeep").removeAttr("style")},sortArray:function(a,
b){a.sort(function(a,e){return(a.length-e.length)*(b||1)});return a},smileFind:function(){if(this.options.smilefind){var a=b(this.options.smilefind).find("img[alt]");0<a.size()&&(this.options.smileList=[],a.each(b.proxy(function(a,d){var e=b(d);this.options.smileList.push({title:e.attr("title"),bbcode:e.attr("alt"),img:e.removeAttr("alt").removeAttr("title")[0].outerHTML})},this)))}},showModal:function(a,c,d){b.log("showModal: "+a);var e=this.$modal.find(".wbbm-content").html(""),f=this.$modal.find(".wbbm").removeClass("hastabs");
this.$modal.find("span.wbbm-title-text").html(c.title);if(c.tabs&&1<c.tabs.length){f.addClass("hastabs");var g=b('<div class="wbbm-tablist">').appendTo(e).append("<ul>").children("ul");b.each(c.tabs,b.proxy(function(a,b){0==a&&(b.on="on");g.append(this.strf("<li class=\"{on}\" onClick=\"$(this).parent().find('.on').removeClass('on');$(this).addClass('on');$(this).parents('.wbbm-content').find('.tab-cont').hide();$(this).parents('.wbbm-content').find('.tab"+a+"').show()\">{title}</li>",b))},this))}c.width&&
f.css("width",c.width);var j=b('<div class="wbbm-cont">').appendTo(e);d?f.find("#wbbm-remove").show():f.find("#wbbm-remove").hide();b.each(c.tabs,b.proxy(function(a,c){var e=b("<div>").addClass("tab-cont tab"+a).attr("tid",a).appendTo(j);0<a&&e.hide();c.html?e.html(this.strf(c.html,this.options)):b.each(c.input,b.proxy(function(a,b){b.value=d[b.param.toLowerCase()];if("seltext"==b.param.toLowerCase()&&(!b.value||""==b.value))b.value=this.getSelectText(this.options.bbmode);e.append(this.strf('<div class="wbbm-inp-row"><label>{title}</label><input class="modal-text" type="text" name="{param}" value="{value}"/></div>',
b))},this))},this));this.lastRange=this.getRange();b.isFunction(c.onLoad)?c.onLoad.call(this,a,c,d):"string"===typeof c.onLoad&&this[c.onLoad].call(this,a,c,d);f.find("#wbbm-submit").click(b.proxy(function(){if(!(b.isFunction(c.onSubmit)&&!1===c.onSubmit.call(this,a,c,d))){var e={},f=!0;this.$modal.find(".wbbm-inperr").remove();this.$modal.find(".wbbm-brdred").removeClass("wbbm-brdred");b.each(this.$modal.find(".tab-cont:visible input"),b.proxy(function(a,d){var g=b(d).parents(".tab-cont").attr("tid"),
j=b(d).attr("name").toLowerCase(),o=b(d).val(),g=c.tabs[g].input[a].validation;"undefined"!=typeof g&&!o.match(RegExp(g,"i"))&&(f=!1,b(d).after('<span class="wbbm-inperr">'+this.options.currentLang.validation_err+"</span>").addClass("wbbm-brdred"));e[j]=o},this));f&&(this.lastRange&&this.selectRange(this.lastRange),d&&this.wbbRemoveCallback(a,!0),this.wbbInsertCallback(a,e),this.closeModal(),this.updateUI())}},this));f.find("#wbbm-remove").click(b.proxy(function(){this.wbbRemoveCallback(a);this.closeModal();
this.updateUI()},this));b(document.body).css("overflow","hidden");b(document.body).height()>b(window).height()&&b(document.body).css("padding-right","20px");this.$modal.show();f.css("margin-top",(b(window).height()-f.outerHeight())/3+"px")},escModal:function(a){27==a.which&&this.closeModal()},closeModal:function(){b(document.body).css("overflow","auto").css("padding-right","0").unbind("keyup",this.escModal);this.$modal.find("#wbbm-submit,#wbbm-remove").unbind("click");this.$modal.hide();this.lastRange=
!1;return this},getParams:function(a,c,d){var e={};if(this.options.bbmode){var f=c.match(/\{[\s\S]+?\}/g),c=this.prepareRGX(c),c=RegExp(c,"g"),g=this.txtArea.value;0<d&&(g=g.substr(d,g.length-d));var j=c.exec(g);j&&b.each(f,function(a,b){e[b.replace(/\{|\}/g,"").replace(/"/g,"'").toLowerCase()]=j[a+1]})}else b.each(this.options.rules[c][0][1],b.proxy(function(c,d){var f="",f=!1!==d.attr?b(a).attr(d.attr):!1!==d.sel?b(a).find(d.sel).html():b(a).html();if(!1!==d.rgx){var g=f.match(RegExp(d.rgx));g&&
2==g.length&&(f=g[1])}e[c]=f.replace(/"/g,"'")},this));return e},imgLoadModal:function(){b.log("imgLoadModal");!0===this.options.imgupload?(this.$modal.find("#imguploader").dragfileupload({url:this.strf(this.options.img_uploadurl,this.options),extraParams:{maxwidth:this.options.img_maxwidth,maxheight:this.options.img_maxheight},themePrefix:this.options.themePrefix,themeName:this.options.themeName,success:b.proxy(function(a){this.$txtArea.insertImage(a.image_link,a.thumb_link);this.closeModal();this.updateUI()},
this)}),b.browser.msie&&(b.log("IE not posting form by security reason, show default file upload"),this.$modal.find("#nicebtn").hide(),this.$modal.find("#fileupl").css("opacity",1)),this.$modal.find("#fileupl").bind("change",function(){b("#fupform").submit()}),this.$modal.find("#fupform").bind("submit",b.proxy(function(a){b(a.target).parents("#imguploader").hide().after('<div class="loader"><img src="'+this.options.themePrefix+"/"+this.options.themeName+'/img/loader.gif" /><br/><span>'+this.options.currentLang.loading+
"</span></div>").parent().css("text-align","center")},this))):(this.$modal.find(".hastabs").removeClass("hastabs"),this.$modal.find("#imguploader").parents(".tab-cont").remove(),this.$modal.find(".wbbm-tablist").remove())},imgSubmitModal:function(){b.log("imgSubmitModal")},printObjectInIE:function(a){try{b.log(JSON.stringify(a))}catch(c){}},checkFilter:function(a,c){b.log("node: "+b(a).get(0).outerHTML+" filter: "+c+" res: "+b(a).is(c.toLowerCase()))}};b.log=function(a){"undefined"!=typeof console&&
console.log(a)};b.fn.wysibb=function(a){return this.each(function(){b(this).data("wbb")||(b.log("Create WysiBB object"),new b.wysibb(this,a))})};b.fn.getDoc=function(){return this.data("wbb").doc};b.fn.getSelectText=function(a){return this.data("wbb").getSelectText(a)};b.fn.bbcode=function(a){return a?(this.data("wbb").$txtArea.val(a),this):this.data("wbb").getBBCode()};b.fn.htmlcode=function(a){return a?(this.data("wbb").$body.html(a),this):this.data("wbb").getHTML(this.data("wbb").$txtArea.val())};
b.fn.getBBCode=function(){return this.data("wbb").getBBCode()};b.fn.getHTML=function(){var a=this.data("wbb");return a.getHTML(a.$txtArea.val())};b.fn.getHTMLByCommand=function(a,b){return this.data("wbb").getHTMLByCommand(a,b)};b.fn.getBBCodeByCommand=function(a,b){return this.data("wbb").getBBCodeByCommand(a,b)};b.fn.insertAtCursor=function(a,b){this.data("wbb").insertAtCursor(a,b)};b.fn.execCommand=function(a,b){this.data("wbb").execCommand(a,b)};b.fn.insertImage=function(a,b){var d=this.data("wbb");
this.insertAtCursor(b?d.getCodeByCommand("link",{url:a,seltext:d.getCodeByCommand("img",{src:b})}):d.getCodeByCommand("img",{src:a}));return d};b.fn.sync=function(){this.data("wbb").sync()};b.fn.queryState=function(a){this.data("wbb").queryState(a)}})(jQuery);
(function(b){function a(a,d){this.$block=b(a);this.opt=b.extend({url:!1,success:!1,extraParams:!1,fileParam:"img",validation:".(jpg|png|gif|jpeg)$",t1:this.options.currentLang.fileupload_text1,t2:this.options.currentLang.fileupload_text2},d);b.log(this.opt)}b.fn.dragfileupload=function(b){return this.each(function(){(new a(this,b)).init()})};a.prototype={init:function(){if(null!=window.FormData){b.log("Init drag&drop file upload");this.$block.addClass("drag");this.$block.prepend('<div class="p2">'+
this.opt.t2+"</div>");this.$block.prepend('<div class="p">'+this.opt.t1+"</div>");this.$block.bind("dragover",function(){b(this).addClass("dragover")});this.$block.bind("dragleave",function(){b(this).removeClass("dragover")});var a=b.proxy(function(a){a=parseInt(100*(a.loaded/a.total),10);this.$loader.children("span").text(this.options.currentLang.loading+": "+a+"%")},this),d=jQuery.ajaxSettings.xhr();d.upload&&d.upload.addEventListener("progress",a,!1);this.$block[0].ondrop=b.proxy(function(a){a.preventDefault();
this.$block.removeClass("dragover");a=a.dataTransfer.files[0];if(!a.name.match(RegExp(this.opt.validation)))return this.error(this.options.currentLang.validation_err),!1;var c=new FormData;c.append(this.opt.fileParam,a);this.opt.extraParams&&b.each(this.opt.extraParams,function(a,b){c.append(a,b)});this.$loader=b('<div class="loader"><img src="'+this.opt.themePrefix+"/"+this.opt.themeName+'/img/loader.gif" /><br/><span>'+this.options.currentLang.loading+"</span></div>");this.$block.html(this.$loader);
b.ajax({type:"POST",url:this.opt.url,data:c,processData:!1,contentType:!1,xhr:function(){return d},dataType:"json",success:b.proxy(function(a){a&&1==a.status?this.opt.success(a):this.error(a.msg||this.options.currentLang.error_onupload)},this),error:b.proxy(function(){this.error(this.options.currentLang.error_onupload)},this)})},this)}},error:function(a){this.$block.find(".upl-error").remove().end().append('<span class="upl-error">'+a+"</span>").addClass("wbbm-brdred")}}})(jQuery);